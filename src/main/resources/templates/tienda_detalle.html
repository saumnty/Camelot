<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${tienda.nombre} + ' | Camelot'">Tienda | Camelot</title>
  <link rel="stylesheet" th:href="@{/css/landing.css}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .detalle-wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    .detalle-card { background: #fff; border-radius: 16px; padding: 18px; box-shadow: 0 6px 20px rgba(0,0,0,.06); }
    .detalle-top { display:flex; gap:14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    .detalle-title { display:flex; gap:12px; align-items:center; }
    .detalle-avatar { width:52px; height:52px; border-radius:14px; display:flex; align-items:center; justify-content:center; background:#7c3aed; color:#fff; font-weight:700; font-size:20px; }
    .badge { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:.85rem; font-weight:600; }
    .badge-normal { background:#eef2ff; color:#3730a3; }
    .badge-prov { background:#f3e8ff; color:#6b21a8; border: 1px dashed #a855f7; }
    .detalle-meta { margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; color:#555; }
    .meta-item { display:flex; gap:8px; align-items:center; background:#f7f7fb; padding:8px 10px; border-radius:10px; }
    .detalle-desc { margin-top:14px; color:#444; line-height:1.45; }
    .acciones { display:flex; gap:10px; flex-wrap:wrap; margin-top:16px; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; text-decoration:none; font-weight:600; }
    .btn-prim { background:#7c3aed; color:#fff; }
    .btn-sec { background:#f3f4f6; color:#111827; }
    .mapa { margin-top:16px; border-radius:16px; overflow:hidden; background:#f3f4f6; }
    .mapa iframe { width:100%; height:320px; border:0; }
    .volver { margin: 14px 0; display:inline-flex; gap:8px; align-items:center; text-decoration:none; color:#111827; }
    html, body {
    height: auto !important;
      overflow-y: auto !important;
    }
  </style>
</head>

<body>
  <div class="detalle-wrap">

    <a class="volver" th:href="@{/home}">
      <i class="fas fa-arrow-left"></i> Volver al inicio
    </a>

    <div class="detalle-card">

      <div class="detalle-top">
        <div class="detalle-title">
          <div class="detalle-avatar" th:text="${#strings.substring(tienda.nombre,0,1)}">T</div>
          <div>
            <h1 style="margin:0;" th:text="${tienda.nombre}">Nombre Tienda</h1>

            <div style="margin-top:8px;">
              <span class="badge"
                    th:classappend="${tienda.tipo.name() == 'PROVEEDOR'} ? ' badge-prov' : ' badge-normal'">
                <i class="fas" th:classappend="${tienda.tipo.name() == 'PROVEEDOR'} ? ' fa-truck' : ' fa-store'"></i>
                <span th:text="${tienda.tipo.name() == 'PROVEEDOR' ? 'PROVEEDORA' : 'TIENDA'}">TIENDA</span>
              </span>
            </div>
          </div>
        </div>

        <div class="acciones">
          <a class="btn btn-prim"
            th:if="${puedeVerCatalogo}"
            th:href="${catalogoUrl}">
            <i class="fas fa-box"></i> Ver catálogo
          </a>

          <span class="btn btn-sec"
                th:if="${!puedeVerCatalogo}"
                style="opacity:.7; cursor:not-allowed;">
            <i class="fas fa-lock"></i> Catálogo restringido
          </span>

          <a class="btn btn-sec" th:if="${tienda.googleMapsUrl != null}" th:href="${tienda.googleMapsUrl}" target="_blank">
            <i class="fas fa-map-location-dot"></i> Abrir mapa
          </a>
        </div>
      </div>

      <div class="detalle-meta">
        <div class="meta-item" th:if="${tienda.categoria != null}">
          <i class="fas fa-tag"></i>
          <span th:text="${tienda.categoria}">Categoría</span>
        </div>
        <div class="meta-item" th:if="${tienda.ciudad != null}">
          <i class="fas fa-location-dot"></i>
          <span th:text="${tienda.ciudad}">Ciudad</span>
        </div>
        <div class="meta-item">
          <i class="fas fa-hashtag"></i>
          <span>ID: <b th:text="${tienda.id}">0</b></span>
        </div>
      </div>

      <p class="detalle-desc"
         th:text="${tienda.descripcion != null ? tienda.descripcion : 'Sin descripción.'}">
        Descripción...
      </p>

      <!-- ====== BLOQUE EXTRA (sin iframe) ====== -->
      <div style="margin-top:16px; display:grid; grid-template-columns: 1fr; gap:14px;">

        <!-- Top productos -->
        <div class="detalle-card" style="padding:14px;" th:if="${topProductos != null && !#lists.isEmpty(topProductos)}">
          <h3 style="margin:0 0 10px;">Productos destacados</h3>

          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px;">
            <div style="border:1px solid #eee; border-radius:12px; padding:10px;"
                th:each="p : ${topProductos}">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                <div style="font-weight:700;" th:text="${p.name}">Producto</div>

                <span class="badge badge-prov" th:if="${p.destacado}">
                  <i class="fas fa-star"></i> Destacado
                </span>
              </div>

              <div style="margin-top:6px; color:#555;">
                $<span th:text="${p.precio}">0.00</span>
                <span style="margin-left:10px;">
                  Stock: <b th:text="${p.stock != null ? p.stock : 'N/A'}">N/A</b>
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Proveedores (solo tiendas normales) -->
        <div class="detalle-card" style="padding:14px;"
            th:if="${tienda.tipo.name() == 'NORMAL' && proveedores != null && !#lists.isEmpty(proveedores)}">
          <h3 style="margin:0 0 10px;">Proveedores asociados</h3>

          <div style="display:flex; flex-wrap:wrap; gap:10px;">
            <a th:each="tp : ${proveedores}"
              th:href="@{/tiendas/{id}(id=${tp.proveedor.id})}"
              style="text-decoration:none; background:#f7f7fb; padding:10px 12px; border-radius:12px; color:#111827;">
              <i class="fas fa-truck" style="margin-right:8px; color:#6b21a8;"></i>
              <span th:text="${tp.proveedor.nombre}">Proveedor</span>
            </a>
          </div>
        </div>

        <!-- Si no hay productos -->
        <div class="detalle-card" style="padding:14px;"
            th:if="${topProductos == null || #lists.isEmpty(topProductos)}">
          <h3 style="margin:0 0 6px;">Productos Restringidos</h3>
          <p style="margin:0; color:#555;">Solo personal con establecimiento puede acceder.</p>
        </div>

        <div class="detalle-card" style="padding:12px; border:2px dashed #f59e0b;">
          <b>DEBUG</b><br>
          authUser: <span th:text="${authUser != null ? authUser.email : 'NULL'}"></span><br>
          yaEsAdminDeEstaTienda: <span th:text="${yaEsAdminDeEstaTienda}"></span><br>
          solicitudPendiente: <span th:text="${solicitudPendiente}"></span>
        </div>


        <!-- ====== SOY DUEÑO (solicitud a admins) ====== -->
        <div class="detalle-card" style="padding:14px; margin-top:14px;"
            th:if="${authUser != null && !yaEsAdminDeEstaTienda}">

          <h3 style="margin:0 0 6px;">¿Eres dueño de esta tienda?</h3>
          <p style="margin:0; color:#555; line-height:1.4;">
            Envía una solicitud para que un administrador la apruebe.
          </p>

          <!-- Mensajes -->
          <div th:if="${msgOk != null}" style="margin-top:10px; background:#ecfdf5; color:#065f46; padding:10px 12px; border-radius:12px;">
            <i class="fas fa-circle-check"></i>
            <span th:text="${msgOk}">Solicitud enviada.</span>
          </div>

          <div th:if="${msgErr != null}" style="margin-top:10px; background:#fef2f2; color:#991b1b; padding:10px 12px; border-radius:12px;">
            <i class="fas fa-triangle-exclamation"></i>
            <span th:text="${msgErr}">Error.</span>
          </div>

          <!-- Si NO hay solicitud pendiente -->
          <form th:action="@{|/tiendas/${tienda.id}/solicitudes/dueno|}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <textarea name="nota" placeholder="Nota (opcional)"></textarea>
            <button type="submit">Soy dueño (enviar solicitud)</button>
          </form>

          <!-- Si YA hay solicitud pendiente -->
          <div th:if="${solicitudPendiente}" style="margin-top:12px;">
            <span class="btn btn-sec" style="opacity:.75; cursor:not-allowed;">
              <i class="fas fa-hourglass-half"></i> Solicitud pendiente de aprobación
            </span>
          </div>

        </div>

        <!-- Si ya es admin -->
        <div class="detalle-card" style="padding:14px; margin-top:14px;"
            th:if="${authUser != null && yaEsAdminDeEstaTienda}">
          <h3 style="margin:0 0 6px;">Eres ADMIN de esta tienda</h3>
          <p style="margin:0 0 10px; color:#555;">
            Puedes gestionar solicitudes desde el panel de administración.
          </p>

          <a th:href="@{|/tiendas/${tienda.id}/solicitudes/admin|}"
            style="display:inline-block; padding:10px 12px; border-radius:10px;
                    background:#6d28d9; color:#fff; text-decoration:none; font-weight:600;">
            Gestionar solicitudes de dueño
          </a>
        </div>

      </div>

    </div>
  </div>
</body>
</html>
